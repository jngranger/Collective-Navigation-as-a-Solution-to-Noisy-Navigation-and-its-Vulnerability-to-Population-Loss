---
title: "Figure 4 and fig 4 supplementals"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(ggplot2)
library(viridis)
directory="C:/Users/Jesse/Dropbox (Duke Bio_Ea)/Jesse/Duke/Research/Navigation Orientation/Flocking Model/Models and Code for Publication/"
source(paste0(directory,"/Cleaning Netlogo Function for Pub.R"))
```

# Num Flockmates

trying to count the number of agents with at least one flockmate, code in netlogo:
show count turtles with [(count other turtles in-cone vision field-of-view) > 1]


Load the data and wrangle into a useable format
```{r}

dfflockmates=read_csv(paste0(directory,"/Flocking Model_Base Model and Pop Loss Count Flockmates-spreadsheet.csv"), col_names = F,skip = 6)

dfflockmates_clean=clean_nlogo_lastonly_EndRunExport(dfflockmates,reps=20,num.variables = 2,
                                    p.max=9,p.min=1,p.by=1,num.things.varied = 2,
                                    var.names = c("AvgFlockmates","NumWith1"),
                                    newcolnames =c("Pop","run","coltype")) %>%
 mutate(Pop = replace(Pop, Pop == 1, 4000)) %>%
 mutate(Pop = replace(Pop, Pop == 2, 2300)) %>%  
 mutate(Pop = replace(Pop, Pop == 3, 2000)) %>%
 mutate(Pop = replace(Pop, Pop == 4, 1500)) %>%  
 mutate(Pop = replace(Pop, Pop == 5, 1000)) %>%
 mutate(Pop = replace(Pop, Pop == 6, 650)) %>%
 mutate(Pop = replace(Pop, Pop == 7, 500)) %>%
 mutate(Pop = replace(Pop, Pop == 8, 400)) %>%
 mutate(Pop = replace(Pop, Pop == 9, 100))

dfflockmates_clean %>% 
  group_by(Pop) %>% 
  mutate(PercentOneFlockmate=(NumWith1/Pop)*100 )%>% 
  summarise(mean(PercentOneFlockmate),sd(PercentOneFlockmate),mean(AvgFlockmates),sd(AvgFlockmates))


```

# Figure 4

Load data and wrangle into a useable format

```{r}
#Load pop 4000
df_4x=read_csv(paste0(directory,"Flocking Model_Base Model and Pop Loss 4x weightnav and errornav-spreadsheet.csv"), col_names = F,skip = 6)

df4x_clean=clean_nlogo_lastonly_EndRunExport(df_4x,reps=5,num.variables = 1,
                                    p.max=1,p.min=.1,p.by=.05,num.things.varied = 3,
                                    e.max=100,e.min=0,e.by=5,
                                    var.names = c("NumHome"),
                                    newcolnames =c("NavWeight","NavError","run","coltype")) %>% 
mutate(Pop = rep(4000),NumFlockmates="25%") %>%
mutate(NumHome=(NumHome/Pop)*100)

# This loads population sizes 2300, 1500, 650, 400 and 100
df_else=read_csv(paste0(directory,"/Flocking Model_Base Model and Pop Loss 2300 1500 650 400 100 weightnav and errornav-spreadsheet.csv"), col_names = F,skip = 6)
dfelse_clean=clean_nlogo_lastonly_EndRunExport(df_else,reps=5,num.variables = 1,
                                    p.max=5,p.min=1,p.by=1,num.things.varied = 4,
                                    e.max=1,e.min=.1,e.by=.05,z.max=100,z.min =0,z.by=5,
                                    var.names = c("NumHome"),
                                    newcolnames =c("Pop","NavWeight","NavError","run","coltype")) %>%
 mutate(NumFlockmates=Pop) %>%
 mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 1,"10%"),Pop = replace(Pop, Pop == 1, 2300)) %>%
 mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 2,"5%"),Pop = replace(Pop, Pop == 2, 1500)) %>%
 mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 3,"1%"),Pop = replace(Pop, Pop == 3, 650)) %>%
   mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 4,"0.5%"),Pop = replace(Pop, Pop == 4, 400))%>%
 mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 5,"0%"),Pop = replace(Pop, Pop == 5, 100))%>%
mutate(NumHome=(NumHome/Pop)*100) 

# This loads population sizes 2000, 1000, 500 and 100
 df_else2=read_csv(paste0(directory,"/Flocking Model_Base Model and Pop Loss 2x 1x 500 100 weightnav and errornav-spreadsheet.csv"), col_names = F,skip = 6)
dfelse2_clean=clean_nlogo_lastonly_EndRunExport(df_else2,reps=5,num.variables = 1,
                                    p.max=4,p.min=1,p.by=1,num.things.varied = 4,
                                    e.max=1,e.min=.1,e.by=.05,z.max=100,z.min =0,z.by=5,
                                    var.names = c("NumHome"),
                                    newcolnames =c("Pop","NavWeight","NavError","run","coltype")) %>%
 mutate(NumFlockmates=Pop) %>%
 mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 1,"10%"),Pop = replace(Pop, Pop == 1, 2000)) %>%
 mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 2,"5%"),Pop = replace(Pop, Pop == 2, 1000)) %>%
   mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 3,"0.5%"),Pop = replace(Pop, Pop == 3, 500))%>%
 mutate(NumFlockmates = replace(NumFlockmates, NumFlockmates == 4,"0%"),Pop = replace(Pop, Pop == 4, 100))%>%
mutate(NumHome=(NumHome/Pop)*100) 


#Bind together
df_clean=rbind(df4x_clean,dfelse_clean,dfelse2_clean)
```

Plot

```{r,fig.width=11, fig.height=3}
df_clean2=df_clean %>%  
  group_by(NavWeight,NavError,Pop,NumFlockmates) %>% 
  summarize(NumHome=mean(NumHome))%>% 
  filter(Pop!=2300 & Pop!=1500 & Pop!=650 & Pop!=500)

(p=df_clean2 %>% 
    mutate(NavWeight=1-NavWeight) %>% #1 - Navweight = Flocking Weight 
    #mutate(NumFlockmates=factor(NumFlockmates,levels=c("0%","0.5%","1%","5%","10%","25%"))) %>% 
    mutate(Pop=factor(Pop,levels=c("4000","2300","2000","1500","1000","650","500","400","100"))) %>% 
ggplot()+
  geom_tile(aes((NavWeight),NavError,fill=NumHome))+
  scale_fill_viridis(direction = -1, name="% Home",limits=c(0,100))+
  #facet_wrap(~NumFlockmates,nrow=1)+
  facet_wrap(~Pop,nrow=1)+
    theme_classic()+
  scale_x_continuous(breaks=seq(0,1,0.2))+
  xlab("Flocking Weight. 0=Asocial, 1=Only Flocking")+
  ylab("Navigational Error (Degrees)  ")+
  theme(
        strip.background = element_blank(),
        strip.text=element_text(size=10,face="bold"),
        plot.title = element_text(hjust = 0.5))+
   guides(fill = guide_colorbar(reverse=T)))

#ggsave("Figure 4_.png",p)
```


# Percent difference/change plots and calculations

```{r,fig.width=11, fig.height=5}
#Plots
library(scales)
df_clean2=df_clean %>%  
  group_by(NavWeight,NavError,Pop,NumFlockmates) %>% 
  summarize(NumHome=mean(NumHome)) %>% 
  filter(Pop!=2300 & Pop!=1500 & Pop!=650 & Pop!=500)

ps=df_clean2 %>%
   group_by(NavError,NavWeight) %>%
   mutate(dNumHome=NumHome[Pop==4000]-NumHome) %>% #Percent diff
   mutate(NumHome=ifelse(Pop==4000 & NumHome<=10,0,NumHome)) %>%  #To prevent small denominator issues
   mutate(PercentChange=(dNumHome/NumHome[Pop==4000])*100) %>%  #Percent Change
   mutate(NavWeight=1-NavWeight) %>% #1 - Navweight = Flocking Weight 
   mutate(Pop=factor(Pop,levels=c("4000","2300","2000","1500","1000","650","500","400","100"))) %>% 
  ggplot()+
    theme_classic()+
    facet_wrap(~Pop,nrow=1)+
    scale_x_discrete(breaks=seq(0,1,0.2))+
    xlab("Flocking Weight. 0=Asocial, 1=Only Flocking")+
    ylab("Navigational Error (Degrees)  ")+
    theme(
        strip.background = element_blank(),
        strip.text=element_text(size=9,face="bold"),
        plot.title = element_text(hjust = 0.5))+
   guides(fill = guide_colorbar(reverse=T))

ps1=ps+geom_tile(aes(factor(NavWeight),NavError,fill=dNumHome))+
    scale_fill_viridis(option="D",name="% Diff",na.value="gray")
ps2=ps+geom_tile(aes(factor(NavWeight),NavError,fill=PercentChange))+
    scale_fill_viridis(option="A",name="% Change",na.value="gray")

library(cowplot)
(ps.all=plot_grid(ps1+theme(axis.text.x = element_blank(),axis.ticks.x = element_blank(),axis.title.x = element_blank()),ps2,nrow=2, labels=c("A","B"),align="vh",rel_heights = c(1,1),label_size = 12))
ggsave("Supplemental Pop Reduction.png",ps.all)


df_clean2 %>%
  group_by(NavError,NavWeight) %>%
   mutate(NumHome=ifelse(Pop==4000 & NumHome<=10,0,NumHome)) %>% 
  mutate(Difference=NumHome[Pop==4000]-NumHome) %>% 
  mutate(PercentChange=((NumHome[Pop==4000]-NumHome)/NumHome[Pop==4000])*100) %>% 
  filter(Pop!=4000) %>% 
  group_by(Pop) %>% 
  summarise(Difference=max(Difference), PercentChange=max(PercentChange,na.rm=T))
```



